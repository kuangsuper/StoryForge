# Toonflow 后端架构设计

## 一、项目结构

```
storyforge/
├── storyforge-server/
│   ├── pom.xml
│   └── src/
│       ├── main/
│       │   ├── java/com/toonflow/
│       │   │   ├── ToonflowApplication.java
│       │   │   │
│       │   │   ├── common/                          # 公共模块
│       │   │   │   ├── ApiResponse.java             # 统一响应
│       │   │   │   ├── BizException.java            # 业务异常
│       │   │   │   ├── ErrorCode.java               # 错误码枚举
│       │   │   │   └── PageResult.java              # 分页结果
│       │   │   │
│       │   │   ├── config/                          # 配置类
│       │   │   │   ├── SecurityConfig.java          # Spring Security
│       │   │   │   ├── WebSocketConfig.java         # WebSocket + STOMP
│       │   │   │   ├── JacksonConfig.java           # JSON序列化
│       │   │   │   ├── AsyncConfig.java             # 异步/Virtual Threads
│       │   │   │   ├── RedisConfig.java             # Redis配置
│       │   │   │   ├── CorsConfig.java              # CORS白名单
│       │   │   │   └── OssConfig.java               # OSS配置
│       │   │   │
│       │   │   ├── security/                        # 安全模块
│       │   │   │   ├── JwtTokenProvider.java        # JWT生成/验证
│       │   │   │   ├── JwtAuthenticationFilter.java # JWT过滤器
│       │   │   │   ├── UserDetailsServiceImpl.java  # 用户认证
│       │   │   │   └── SecurityUtil.java            # 获取当前用户
│       │   │   │
│       │   │   ├── controller/                      # 控制器层
│       │   │   │   ├── AuthController.java
│       │   │   │   ├── UserController.java
│       │   │   │   ├── ProjectController.java
│       │   │   │   ├── NovelController.java
│       │   │   │   ├── NovelGenerationController.java
│       │   │   │   ├── StorylineController.java
│       │   │   │   ├── OutlineController.java
│       │   │   │   ├── ScriptController.java
│       │   │   │   ├── AssetController.java
│       │   │   │   ├── StoryboardController.java
│       │   │   │   ├── VideoController.java
│       │   │   │   ├── VideoComposeController.java
│       │   │   │   ├── TtsController.java
│       │   │   │   ├── MaterialController.java
│       │   │   │   ├── ConfigController.java
│       │   │   │   ├── PromptController.java
│       │   │   │   ├── TaskController.java
│       │   │   │   ├── SettingController.java
│       │   │   │   ├── PipelineController.java
│       │   │   │   └── MonitorController.java
│       │   │   │
│       │   │   ├── dto/                             # 数据传输对象
│       │   │   │   ├── request/                     # 请求DTO
│       │   │   │   │   ├── LoginRequest.java
│       │   │   │   │   ├── CreateProjectRequest.java
│       │   │   │   │   ├── AddNovelRequest.java
│       │   │   │   │   ├── NovelGenerationRequest.java
│       │   │   │   │   ├── GenerateScriptRequest.java
│       │   │   │   │   ├── GenerateVideoRequest.java
│       │   │   │   │   ├── VideoComposeRequest.java
│       │   │   │   │   ├── PipelineRequest.java
│       │   │   │   │   └── ...
│       │   │   │   └── response/                    # 响应DTO
│       │   │   │       ├── LoginResponse.java
│       │   │   │       ├── ProjectDetailResponse.java
│       │   │   │       ├── NovelChapterResponse.java
│       │   │   │       └── ...
│       │   │   │
│       │   │   ├── entity/                          # MyBatis-Plus Entity
│       │   │   │   ├── User.java
│       │   │   │   ├── UserRole.java
│       │   │   │   ├── UserQuota.java
│       │   │   │   ├── Project.java
│       │   │   │   ├── Novel.java
│       │   │   │   ├── NovelVersion.java
│       │   │   │   ├── NovelWorld.java
│       │   │   │   ├── NovelCharacter.java
│       │   │   │   ├── NovelOutline.java
│       │   │   │   ├── NovelChapterPlan.java
│       │   │   │   ├── NovelQualityReport.java
│       │   │   │   ├── Storyline.java
│       │   │   │   ├── Outline.java
│       │   │   │   ├── Script.java
│       │   │   │   ├── Assets.java
│       │   │   │   ├── Image.java
│       │   │   │   ├── Video.java
│       │   │   │   ├── VideoConfig.java
│       │   │   │   ├── VideoComposeConfig.java
│       │   │   │   ├── VideoCompose.java
│       │   │   │   ├── Config.java
│       │   │   │   ├── AiModelMap.java
│       │   │   │   ├── Setting.java
│       │   │   │   ├── Prompts.java
│       │   │   │   ├── ChatHistory.java
│       │   │   │   ├── TaskList.java
│       │   │   │   ├── AgentLog.java
│       │   │   │   ├── TtsConfig.java
│       │   │   │   ├── TtsAudio.java
│       │   │   │   └── Material.java
│       │   │   │
│       │   │   ├── entity/json/                     # JSON字段POJO
│       │   │   │   ├── EpisodeData.java
│       │   │   │   ├── AssetItem.java
│       │   │   │   ├── PowerSystem.java
│       │   │   │   ├── SocialStructure.java
│       │   │   │   ├── CharacterState.java
│       │   │   │   ├── SpeechStyle.java
│       │   │   │   ├── ChapterSummary.java
│       │   │   │   ├── QualityDimensions.java
│       │   │   │   ├── SubtitleStyle.java
│       │   │   │   └── ChatMessage.java
│       │   │   │
│       │   │   ├── mapper/                          # MyBatis-Plus Mapper
│       │   │   │   ├── UserMapper.java
│       │   │   │   ├── ProjectMapper.java
│       │   │   │   ├── NovelMapper.java
│       │   │   │   ├── ... (每张表一个Mapper)
│       │   │   │   └── MaterialMapper.java
│       │   │   │
│       │   │   ├── service/                         # 业务服务层
│       │   │   │   ├── AuthService.java
│       │   │   │   ├── UserService.java
│       │   │   │   ├── ProjectService.java
│       │   │   │   ├── NovelService.java
│       │   │   │   ├── NovelGenerationService.java
│       │   │   │   ├── StorylineService.java
│       │   │   │   ├── OutlineService.java
│       │   │   │   ├── ScriptService.java
│       │   │   │   ├── AssetService.java
│       │   │   │   ├── StoryboardService.java
│       │   │   │   ├── ImageService.java
│       │   │   │   ├── VideoService.java
│       │   │   │   ├── VideoComposeService.java
│       │   │   │   ├── TtsService.java
│       │   │   │   ├── MaterialService.java
│       │   │   │   ├── ConfigService.java
│       │   │   │   ├── PromptService.java
│       │   │   │   ├── TaskService.java
│       │   │   │   ├── SettingService.java
│       │   │   │   ├── PipelineService.java
│       │   │   │   ├── MonitorService.java
│       │   │   │   ├── ExportService.java
│       │   │   │   ├── OssService.java
│       │   │   │   └── QuotaService.java
│       │   │   │
│       │   │   ├── agent/                           # 多智能体系统
│       │   │   │   ├── core/                        # Agent核心框架
│       │   │   │   │   ├── BaseAgent.java           # Agent抽象基类
│       │   │   │   │   ├── AgentTool.java           # 工具接口
│       │   │   │   │   ├── ToolRegistry.java        # 工具注册表
│       │   │   │   │   ├── AgentContext.java         # Agent上下文
│       │   │   │   │   ├── AgentEmitter.java        # WebSocket事件发射器
│       │   │   │   │   ├── AgentSession.java        # Agent会话管理
│       │   │   │   │   ├── MessageQueue.java        # 消息队列(FIFO)
│       │   │   │   │   └── CheckpointManager.java   # 断点续写管理
│       │   │   │   │
│       │   │   │   ├── outline/                     # 大纲故事线Agent (M7)
│       │   │   │   │   ├── OutlineMainAgent.java    # MainAgent
│       │   │   │   │   ├── StorytellerAgent.java    # AI1 故事师
│       │   │   │   │   ├── OutlinerAgent.java       # AI2 大纲师
│       │   │   │   │   ├── DirectorAgent.java       # 导演
│       │   │   │   │   └── OutlineToolSet.java      # 工具集
│       │   │   │   │
│       │   │   │   ├── novel/                       # 小说生成Agent (M4)
│       │   │   │   │   ├── NovelMainAgent.java      # 总编/调度器
│       │   │   │   │   ├── WorldArchitect.java      # 世界架构师
│       │   │   │   │   ├── CharacterDesigner.java   # 角色设计师
│       │   │   │   │   ├── PlotArchitect.java       # 情节架构师
│       │   │   │   │   ├── ChapterPlanner.java      # 章节规划师
│       │   │   │   │   ├── NovelWriter.java         # 小说写手
│       │   │   │   │   ├── EditorAgent.java         # 总编审
│       │   │   │   │   ├── QualityInspector.java    # 质检官
│       │   │   │   │   ├── NovelToolSet.java        # 工具集
│       │   │   │   │   └── ContextAssembler.java    # 上下文组装器(四层记忆)
│       │   │   │   │
│       │   │   │   └── storyboard/                  # 分镜Agent (M11)
│       │   │   │       ├── StoryboardMainAgent.java # MainAgent
│       │   │   │       ├── SegmentAgent.java        # 片段师
│       │   │   │       ├── ShotAgent.java           # 分镜师
│       │   │   │       └── StoryboardToolSet.java   # 工具集
│       │   │   │
│       │   │   ├── ai/                              # AI Provider层
│       │   │   │   ├── AiRequest.java               # 通用AI请求
│       │   │   │   ├── text/
│       │   │   │   │   ├── TextAiProvider.java      # 文本AI接口
│       │   │   │   │   ├── TextAiProviderFactory.java
│       │   │   │   │   ├── TextModelRegistry.java   # 模型能力注册表
│       │   │   │   │   └── impl/
│       │   │   │   │       ├── DeepSeekProvider.java
│       │   │   │   │       ├── QwenProvider.java
│       │   │   │   │       ├── DoubaoProvider.java
│       │   │   │   │       ├── ZhipuProvider.java
│       │   │   │   │       ├── OpenAiProvider.java
│       │   │   │   │       ├── GeminiProvider.java
│       │   │   │   │       ├── AnthropicProvider.java
│       │   │   │   │       ├── XaiProvider.java
│       │   │   │   │       └── OpenAiCompatibleProvider.java
│       │   │   │   ├── image/
│       │   │   │   │   ├── ImageAiProvider.java
│       │   │   │   │   ├── ImageAiProviderFactory.java
│       │   │   │   │   ├── ImageRequest.java
│       │   │   │   │   └── impl/
│       │   │   │   │       ├── GeminiImageProvider.java
│       │   │   │   │       ├── VolcengineImageProvider.java
│       │   │   │   │       ├── KlingImageProvider.java
│       │   │   │   │       ├── ViduImageProvider.java
│       │   │   │   │       └── RunninghubImageProvider.java
│       │   │   │   ├── video/
│       │   │   │   │   ├── VideoAiProvider.java
│       │   │   │   │   ├── VideoAiProviderFactory.java
│       │   │   │   │   ├── VideoRequest.java
│       │   │   │   │   ├── VideoTaskResult.java
│       │   │   │   │   └── impl/
│       │   │   │   │       ├── VolcengineVideoProvider.java
│       │   │   │   │       ├── KlingVideoProvider.java
│       │   │   │   │       ├── ViduVideoProvider.java
│       │   │   │   │       ├── WanVideoProvider.java
│       │   │   │   │       ├── GeminiVideoProvider.java
│       │   │   │   │       ├── RunninghubVideoProvider.java
│       │   │   │   │       └── ApimartVideoProvider.java
│       │   │   │   └── tts/
│       │   │   │       ├── TtsAiProvider.java
│       │   │   │       ├── TtsAiProviderFactory.java
│       │   │   │       └── impl/
│       │   │   │           ├── VolcengineTtsProvider.java
│       │   │   │           ├── AliyunTtsProvider.java
│       │   │   │           ├── AzureTtsProvider.java
│       │   │   │           └── FishAudioTtsProvider.java
│       │   │   │
│       │   │   ├── websocket/                       # WebSocket处理
│       │   │   │   ├── AgentWebSocketHandler.java   # Agent WS处理器
│       │   │   │   ├── PipelineWebSocketHandler.java# 流水线WS处理器
│       │   │   │   └── WebSocketSessionManager.java # 会话管理
│       │   │   │
│       │   │   ├── pipeline/                        # 全自动流水线
│       │   │   │   ├── PipelineExecutor.java        # 流水线执行器
│       │   │   │   ├── PipelineState.java           # 状态机
│       │   │   │   └── PipelineStep.java            # 步骤定义
│       │   │   │
│       │   │   └── util/                            # 工具类
│       │   │       ├── OssClient.java               # OSS客户端(S3兼容)
│       │   │       ├── AesUtil.java                 # AES加解密
│       │   │       ├── ToonSerializer.java          # TOON格式序列化
│       │   │       └── IdGenerator.java             # ID生成器
│       │   │
│       │   └── resources/
│       │       ├── application.yml
│       │       ├── application-dev.yml
│       │       ├── application-prod.yml
│       │       └── mapper/                          # MyBatis XML(复杂查询)
│       │
│       └── test/
│           └── java/com/toonflow/
│               └── ...
```

## 二、核心依赖（build.gradle.kts）

```kotlin
plugins {
    java
    id("org.springframework.boot") version "3.3.5"
    id("io.spring.dependency-management") version "1.1.6"
}

java {
    toolchain { languageVersion = JavaLanguageVersion.of(21) }
}

dependencies {
    // Spring Boot
    implementation("org.springframework.boot:spring-boot-starter-web")
    implementation("org.springframework.boot:spring-boot-starter-websocket")
    implementation("org.springframework.boot:spring-boot-starter-security")
    implementation("org.springframework.boot:spring-boot-starter-validation")
    implementation("org.springframework.boot:spring-boot-starter-data-redis")

    // MyBatis-Plus
    implementation("com.baomidou:mybatis-plus-spring-boot3-starter:3.5.9")
    runtimeOnly("com.mysql:mysql-connector-j")

    // JWT
    implementation("io.jsonwebtoken:jjwt-api:0.12.6")
    runtimeOnly("io.jsonwebtoken:jjwt-impl:0.12.6")
    runtimeOnly("io.jsonwebtoken:jjwt-jackson:0.12.6")

    // Spring AI (OpenAI兼容厂商)
    implementation("org.springframework.ai:spring-ai-openai-spring-boot-starter:1.0.0")

    // OkHttp (国产厂商HTTP调用)
    implementation("com.squareup.okhttp3:okhttp:4.12.0")

    // AWS S3 SDK (OSS统一接口)
    implementation("software.amazon.awssdk:s3:2.29.0")

    // 工具库
    implementation("cn.hutool:hutool-all:5.8.32")
    implementation("org.projectlombok:lombok")
    annotationProcessor("org.projectlombok:lombok")

    // 测试
    testImplementation("org.springframework.boot:spring-boot-starter-test")
}
```

## 三、核心类设计

### 3.1 统一响应与异常

```java
// 统一响应
public record ApiResponse<T>(int code, String message, T data) {
    public static <T> ApiResponse<T> ok(T data) {
        return new ApiResponse<>(200, "success", data);
    }
    public static <T> ApiResponse<T> ok() {
        return new ApiResponse<>(200, "success", null);
    }
    public static <T> ApiResponse<T> error(int code, String message) {
        return new ApiResponse<>(code, message, null);
    }
}

// 分页结果
public record PageResult<T>(List<T> records, long total, int page, int size) {}

// 错误码
public enum ErrorCode {
    UNAUTHORIZED(401, "未登录或Token已过期"),
    FORBIDDEN(403, "无权限"),
    NOT_FOUND(404, "资源不存在"),
    QUOTA_EXCEEDED(429, "配额已用完"),
    BIZ_ERROR(500, "业务异常"),
    AI_CALL_FAILED(510, "AI调用失败"),
    AI_TIMEOUT(511, "AI调用超时");

    public final int code;
    public final String message;
    ErrorCode(int code, String message) {
        this.code = code;
        this.message = message;
    }
}

// 业务异常
public class BizException extends RuntimeException {
    private final int code;
    public BizException(ErrorCode errorCode) {
        super(errorCode.message);
        this.code = errorCode.code;
    }
    public BizException(int code, String message) {
        super(message);
        this.code = code;
    }
}
```

### 3.2 全局异常处理

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(BizException.class)
    public ApiResponse<?> handleBiz(BizException e) {
        return ApiResponse.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ApiResponse<?> handleValidation(MethodArgumentNotValidException e) {
        String msg = e.getBindingResult().getFieldErrors().stream()
            .map(f -> f.getField() + ": " + f.getDefaultMessage())
            .collect(Collectors.joining(", "));
        return ApiResponse.error(400, msg);
    }

    @ExceptionHandler(Exception.class)
    public ApiResponse<?> handleUnknown(Exception e) {
        log.error("未知异常", e);
        return ApiResponse.error(500, "服务器内部错误");
    }
}
```

### 3.3 JWT 安全模块

```java
// JwtTokenProvider — 生成/验证/解析 Token
@Component
public class JwtTokenProvider {
    // 密钥从 t_setting.token_key 读取，缓存到 Redis
    // Token 有效期 24h，存 Redis 支持主动失效
    // Token payload: {userId, name, role, exp}

    public String generateToken(Long userId, String name, String role);
    public Long getUserIdFromToken(String token);
    public boolean validateToken(String token);
    public void invalidateToken(String token); // 主动失效，删 Redis
}

// JwtAuthenticationFilter — OncePerRequestFilter
// 从 Authorization: Bearer xxx 提取 Token
// 验证后设置 SecurityContext
// 白名单: POST /api/auth/login, WebSocket 握手端点

// SecurityUtil — 静态工具
public class SecurityUtil {
    public static Long getCurrentUserId();  // 从 SecurityContext 获取
    public static String getCurrentRole();
}
```

### 3.4 AI Provider 层

```java
// 文本AI统一接口
public interface TextAiProvider {
    // 一次性生成（结构化输出）
    <T> T invoke(AiRequest request, Class<T> outputType);
    // 一次性生成（纯文本）
    String invoke(AiRequest request);
    // 流式生成
    Flux<String> stream(AiRequest request);
}

// AI请求
@Data
@Builder
public class AiRequest {
    private String systemPrompt;
    private List<ChatMessage> messages;
    private List<ToolDefinition> tools;     // Function Calling 工具定义
    private String responseFormat;           // "text" / "json_schema"
    private String jsonSchema;               // JSON Schema 字符串
    private Double temperature;
    private Integer maxTokens;
    private List<String> imageUrls;          // 多模态图片输入
}

// 工厂 — 根据 t_config.manufacturer 创建对应 Provider
@Component
public class TextAiProviderFactory {
    public TextAiProvider create(Config config) {
        return switch (config.getManufacturer()) {
            case "deepseek"  -> new DeepSeekProvider(config);
            case "qwen"      -> new QwenProvider(config);
            case "doubao"    -> new DoubaoProvider(config);
            case "zhipu"     -> new ZhipuProvider(config);
            case "openai"    -> new OpenAiProvider(config);
            case "gemini"    -> new GeminiProvider(config);
            case "anthropic" -> new AnthropicProvider(config);
            case "xai"       -> new XaiProvider(config);
            default          -> new OpenAiCompatibleProvider(config);
        };
    }
}

// 模型能力注册表 — 标记每个模型支持的能力
public class TextModelRegistry {
    // 能力标记: responseFormat(schema/object), image, think, tool
    // 运行时根据能力决定:
    //   - 结构化输出用 schema 还是 prompt+后处理
    //   - 是否支持 Function Calling
    //   - 是否支持多模态图片输入
}

// 图片AI / 视频AI / TTS 接口同理，略
```

### 3.5 WebSocket 配置

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        registry.enableSimpleBroker("/topic");  // 服务端推送前缀
        registry.setApplicationDestinationPrefixes("/app"); // 客户端发送前缀
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws/agent/outline/{projectId}")
                .setAllowedOriginPatterns("*");
        registry.addEndpoint("/ws/agent/storyboard/{projectId}")
                .setAllowedOriginPatterns("*");
        registry.addEndpoint("/ws/agent/novel/{projectId}")
                .setAllowedOriginPatterns("*");
        registry.addEndpoint("/ws/pipeline/{projectId}")
                .setAllowedOriginPatterns("*");
    }
}
```

### 3.6 Virtual Threads 配置

```java
@Configuration
public class AsyncConfig {

    @Bean
    public AsyncTaskExecutor applicationTaskExecutor() {
        // JDK 21 Virtual Threads 作为默认线程池
        return new TaskExecutorAdapter(Executors.newVirtualThreadPerTaskExecutor());
    }

    @Bean
    public TomcatProtocolHandlerCustomizer<?> protocolHandlerVirtualThreadExecutorCustomizer() {
        return protocolHandler ->
            protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());
    }
}
```

### 3.7 application.yml 核心配置

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/toonflow?useUnicode=true&characterEncoding=utf8mb4&serverTimezone=Asia/Shanghai
    username: toonflow
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
  data:
    redis:
      host: localhost
      port: 6379
      password: ${REDIS_PASSWORD}
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB
  threads:
    virtual:
      enabled: true

mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  configuration:
    map-underscore-to-camel-case: true
  global-config:
    db-config:
      id-type: auto

# 自定义配置
toonflow:
  jwt:
    expiration: 86400000  # 24h
  oss:
    endpoint: ${OSS_ENDPOINT}
    access-key: ${OSS_ACCESS_KEY}
    secret-key: ${OSS_SECRET_KEY}
    bucket: ${OSS_BUCKET}
  python-service:
    base-url: http://localhost:8001
  aes:
    key: ${AES_KEY}  # API Key 加密密钥
```

## 四、Entity 示例（JSON 字段处理）

```java
@Data
@TableName("t_outline")
public class Outline {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long projectId;
    private Integer episode;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private EpisodeData data;

    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}

@Data
@TableName("t_novel_character")
public class NovelCharacter {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long projectId;
    private String name;
    private String role;
    private Integer age;
    private String appearance;
    private String personality;
    private String ability;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private Map<String, String> relationships;

    private String growthArc;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private CharacterState currentState;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private SpeechStyle speechStyle;

    private String voiceId;
    private Integer state;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
```

## 五、JSON 字段 POJO

```java
// 大纲集数据
public record EpisodeData(
    int episodeIndex,
    String title,
    List<Integer> chapterRange,
    List<AssetItem> scenes,
    List<AssetItem> characters,
    List<AssetItem> props,
    String coreConflict,
    String outline,
    String openingHook,
    List<String> keyEvents,
    String emotionalCurve,
    List<String> visualHighlights,
    String endingHook,
    List<String> classicQuotes
) {}

public record AssetItem(String name, String description) {}

// 角色状态快照
public record CharacterState(
    String location,
    String physicalState,
    String emotionalState,
    String powerLevel,
    List<String> inventory,
    List<String> knownInfo,
    List<String> unknownInfo,
    int lastUpdatedChapter
) {}

// 对话风格
public record SpeechStyle(
    String tone,
    List<String> habits,
    List<String> vocabulary,
    List<String> exampleDialogues
) {}

// 力量体系
public record PowerSystem(
    String name,
    List<String> levels,
    String rules,
    List<String> specialAbilities
) {}

// 社会结构
public record SocialStructure(
    List<String> factions,
    String hierarchy
) {}

// 章节摘要（AI生成后存入 t_novel.summary）
public record ChapterSummary(
    String plot,
    List<CharacterChange> characterChanges,
    List<Foreshadowing> newForeshadowing,
    List<ForeshadowingResolution> resolvedForeshadowing,
    List<String> worldStateChanges,
    Map<String, String> locationEnd,
    String timelineMarker
) {}

public record CharacterChange(String name, String change) {}
public record Foreshadowing(String id, String content, int plantedAt) {}
public record ForeshadowingResolution(String id, int resolvedAt, String resolution) {}

// 质检维度
public record QualityDimensions(
    DimensionScore characterConsistency,
    DimensionScore plotCoherence,
    DimensionScore worldCompliance,
    DimensionScore foreshadowIntegrity,
    DimensionScore genreSatisfaction,
    DimensionScore writingQuality,
    DimensionScore readability
) {}

public record DimensionScore(int score, List<QualityIssue> issues) {}
public record QualityIssue(String severity, String location, String description, String suggestion) {}

// 字幕样式
public record SubtitleStyle(
    String fontFamily,
    int fontSize,
    String color,
    String position,
    String strokeColor,
    int strokeWidth
) {}
```
