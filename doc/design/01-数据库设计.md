# Toonflow 数据库设计

## 一、数据库规范

- 数据库：MySQL 8.0+，字符集 `utf8mb4`，排序规则 `utf8mb4_unicode_ci`
- 表名前缀：`t_`，字段命名：`snake_case`
- 主键：`BIGINT AUTO_INCREMENT`
- 时间字段：`DATETIME`，Java 映射为 `LocalDateTime`
- JSON 字段：MySQL `JSON` 类型，`NOT NULL DEFAULT ('{}')` 或 `('[]')`，MyBatis-Plus `JacksonTypeHandler`
- 大文本：`TEXT` 或 `MEDIUMTEXT`，`NOT NULL DEFAULT ''`
- 业务必填字段：`NOT NULL` + 具体默认值
- 外键引用字段：允许 `NULL`，表示"未关联"
- 时间状态字段（start_time/end_time）：允许 `NULL`，表示"未发生"
- 逻辑删除：不使用，物理删除 + 版本历史表
- 所有表包含 `create_time`，部分表包含 `update_time`

## 二、建表 SQL（30 张表）

### 2.1 用户与认证（3 张表）

```sql
-- 用户表
CREATE TABLE t_user (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    name        VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '用户名',
    password    VARCHAR(100) NOT NULL DEFAULT '' COMMENT 'BCrypt加密密码',
    email       VARCHAR(100) NOT NULL DEFAULT '' COMMENT '邮箱',
    avatar      VARCHAR(255) NOT NULL DEFAULT '' COMMENT '头像路径',
    status      TINYINT      NOT NULL DEFAULT 1 COMMENT '状态: 1=正常, 0=禁用',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 用户角色表
CREATE TABLE t_user_role (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id     BIGINT       NOT NULL DEFAULT 0 COMMENT '用户ID',
    role        VARCHAR(20)  NOT NULL DEFAULT 'creator' COMMENT '角色: super_admin/admin/creator/viewer',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户角色表';

-- 用户配额表
CREATE TABLE t_user_quota (
    id                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id             BIGINT   NOT NULL DEFAULT 0 COMMENT '用户ID',
    daily_chapter_limit INT      NOT NULL DEFAULT 50 COMMENT '每日章节生成上限',
    daily_image_limit   INT      NOT NULL DEFAULT 200 COMMENT '每日图片生成上限',
    daily_video_limit   INT      NOT NULL DEFAULT 100 COMMENT '每日视频生成上限',
    used_chapters       INT      NOT NULL DEFAULT 0 COMMENT '今日已用章节数',
    used_images         INT      NOT NULL DEFAULT 0 COMMENT '今日已用图片数',
    used_videos         INT      NOT NULL DEFAULT 0 COMMENT '今日已用视频数',
    reset_date          DATE     NOT NULL DEFAULT (CURDATE()) COMMENT '配额重置日期',
    create_time         DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time         DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户配额表';
```

### 2.2 项目管理（1 张表）

```sql
CREATE TABLE t_project (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    name        VARCHAR(100) NOT NULL DEFAULT '' COMMENT '项目名称',
    intro       TEXT         NOT NULL COMMENT '项目简介',
    type        VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '类型: 都市/玄幻/科幻/言情/悬疑/无限流/系统流...',
    art_style   VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '画风: CG/二次元/水墨/写实/赛博朋克...',
    video_ratio VARCHAR(10)  NOT NULL DEFAULT '16:9' COMMENT '视频画幅比: 16:9/9:16/1:1/4:3',
    user_id     BIGINT       NOT NULL DEFAULT 0 COMMENT '创建者ID',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='项目表';
```

### 2.3 小说管理（2 张表）

```sql
-- 小说章节表（手动上传 + AI生成共用）
CREATE TABLE t_novel (
    id            BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id    BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    chapter_index INT          NOT NULL DEFAULT 0 COMMENT '章节序号',
    volume_index  INT          NOT NULL DEFAULT 0 COMMENT '卷序号(0=未分卷)',
    reel          VARCHAR(100) NOT NULL DEFAULT '' COMMENT '分卷名',
    chapter       VARCHAR(200) NOT NULL DEFAULT '' COMMENT '章节名',
    chapter_data  MEDIUMTEXT   NOT NULL COMMENT '章节全文',
    summary       TEXT         NOT NULL COMMENT '章节摘要(JSON结构化)',
    create_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_project_chapter (project_id, chapter_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='小说章节表';

-- 章节版本历史表
CREATE TABLE t_novel_version (
    id            BIGINT AUTO_INCREMENT PRIMARY KEY,
    novel_id      BIGINT       NOT NULL DEFAULT 0 COMMENT '关联t_novel.id',
    project_id    BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    chapter_index INT          NOT NULL DEFAULT 0 COMMENT '章节序号',
    chapter_data  MEDIUMTEXT   NOT NULL COMMENT '该版本正文全文',
    summary       TEXT         NOT NULL COMMENT '该版本摘要',
    source        VARCHAR(20)  NOT NULL DEFAULT 'generate' COMMENT '版本来源: generate/regenerate/polish/autofix/manual',
    version       INT          NOT NULL DEFAULT 1 COMMENT '版本号(自增)',
    create_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_novel_id (novel_id),
    INDEX idx_project_chapter (project_id, chapter_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='章节版本历史表';
```

### 2.4 AI 小说生成（5 张表）

```sql
-- 小说世界观表
CREATE TABLE t_novel_world (
    id               BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id       BIGINT   NOT NULL DEFAULT 0 COMMENT '项目ID',
    background       TEXT     NOT NULL COMMENT '世界背景描述',
    power_system     JSON     NOT NULL DEFAULT ('{}') COMMENT '力量体系JSON',
    social_structure JSON     NOT NULL DEFAULT ('{}') COMMENT '社会结构JSON',
    core_rules       JSON     NOT NULL DEFAULT ('[]') COMMENT '核心规则JSON数组',
    taboos           JSON     NOT NULL DEFAULT ('[]') COMMENT '禁忌设定JSON数组',
    state            TINYINT  NOT NULL DEFAULT 0 COMMENT '状态: 0=草稿, 1=已审核',
    create_time      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_project_id (project_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='小说世界观表';

-- 小说角色档案表
CREATE TABLE t_novel_character (
    id            BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id    BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    name          VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '角色名',
    role          VARCHAR(20)  NOT NULL DEFAULT 'supporting' COMMENT '角色类型: protagonist/supporting/antagonist',
    age           INT          NOT NULL DEFAULT 0 COMMENT '年龄(0=未设定)',
    appearance    TEXT         NOT NULL COMMENT '外貌描述',
    personality   TEXT         NOT NULL COMMENT '性格描述',
    ability       TEXT         NOT NULL COMMENT '能力描述',
    relationships JSON         NOT NULL DEFAULT ('{}') COMMENT '关系网JSON',
    growth_arc    TEXT         NOT NULL COMMENT '成长弧线',
    current_state JSON         NOT NULL DEFAULT ('{}') COMMENT '当前状态快照JSON',
    speech_style  JSON         NOT NULL DEFAULT ('{}') COMMENT '对话风格JSON',
    voice_id      VARCHAR(100) NOT NULL DEFAULT '' COMMENT 'TTS音色ID',
    state         TINYINT      NOT NULL DEFAULT 0 COMMENT '状态: 0=草稿, 1=已审核',
    create_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='小说角色档案表';

-- 小说大纲+分卷表
CREATE TABLE t_novel_outline (
    id                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id          BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    main_plot           TEXT         NOT NULL COMMENT '全书主线',
    theme               VARCHAR(200) NOT NULL DEFAULT '' COMMENT '主题',
    volume_index        INT          NOT NULL DEFAULT 0 COMMENT '卷序号',
    volume_name         VARCHAR(100) NOT NULL DEFAULT '' COMMENT '卷名',
    volume_plot         TEXT         NOT NULL COMMENT '卷主线',
    start_chapter       INT          NOT NULL DEFAULT 0 COMMENT '起始章节',
    end_chapter         INT          NOT NULL DEFAULT 0 COMMENT '结束章节',
    volume_climax       TEXT         NOT NULL COMMENT '卷高潮',
    volume_cliffhanger  TEXT         NOT NULL COMMENT '卷悬念',
    state               TINYINT      NOT NULL DEFAULT 0 COMMENT '状态: 0=草稿, 1=已审核',
    create_time         DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time         DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    UNIQUE KEY uk_project_volume (project_id, volume_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='小说大纲分卷表';

-- 章概要表
CREATE TABLE t_novel_chapter_plan (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id      BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    volume_index    INT          NOT NULL DEFAULT 0 COMMENT '所属卷序号',
    chapter_index   INT          NOT NULL DEFAULT 0 COMMENT '全书章节序号',
    title           VARCHAR(200) NOT NULL DEFAULT '' COMMENT '章节标题',
    summary         TEXT         NOT NULL COMMENT '200-500字情节概要',
    key_events      JSON         NOT NULL DEFAULT ('[]') COMMENT '核心事件列表JSON',
    characters      JSON         NOT NULL DEFAULT ('[]') COMMENT '出场角色列表JSON',
    emotion_curve   VARCHAR(200) NOT NULL DEFAULT '' COMMENT '情绪节奏',
    foreshadowing   JSON         NOT NULL DEFAULT ('[]') COMMENT '本章埋设伏笔JSON',
    payoff          JSON         NOT NULL DEFAULT ('[]') COMMENT '本章回收伏笔JSON',
    cliffhanger     TEXT         NOT NULL COMMENT '章末悬念',
    word_target     INT          NOT NULL DEFAULT 3000 COMMENT '目标字数',
    state           TINYINT      NOT NULL DEFAULT 0 COMMENT '状态: 0=草稿, 1=已审核',
    create_time     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    UNIQUE KEY uk_project_chapter (project_id, chapter_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='章概要表';

-- 小说质检报告表
CREATE TABLE t_novel_quality_report (
    id                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id           BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    scope                VARCHAR(20)  NOT NULL DEFAULT 'chapter' COMMENT '质检范围: chapter/volume/book',
    scope_index          INT          NOT NULL DEFAULT 0 COMMENT '范围索引(章节号/卷号, 0=全书)',
    overall_score        INT          NOT NULL DEFAULT 0 COMMENT '总分(0-100)',
    dimensions           JSON         NOT NULL DEFAULT ('{}') COMMENT '7维度评分详情JSON',
    summary              TEXT         NOT NULL COMMENT '质检总结',
    auto_fix_suggestions JSON         NOT NULL DEFAULT ('[]') COMMENT '自动修复建议JSON',
    state                VARCHAR(20)  NOT NULL DEFAULT 'pending' COMMENT '状态: pending/completed/fixed/ignored',
    create_time          DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_project_scope (project_id, scope, scope_index)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='小说质检报告表';
```

### 2.5 故事线与大纲（2 张表）

```sql
-- 故事线表
CREATE TABLE t_storyline (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id  BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    name        VARCHAR(200) NOT NULL DEFAULT '' COMMENT '故事线名称',
    content     MEDIUMTEXT   NOT NULL COMMENT '故事线全文',
    novel_ids   VARCHAR(500) NOT NULL DEFAULT '' COMMENT '关联章节ID列表(逗号分隔)',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='故事线表';

-- 大纲表（分集大纲，用于短剧生产）
CREATE TABLE t_outline (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id  BIGINT   NOT NULL DEFAULT 0 COMMENT '项目ID',
    episode     INT      NOT NULL DEFAULT 0 COMMENT '集数序号',
    data        JSON     NOT NULL DEFAULT ('{}') COMMENT 'EpisodeData JSON',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    UNIQUE KEY uk_project_episode (project_id, episode)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='大纲表';
```

### 2.6 剧本与资产（3 张表）

```sql
-- 剧本表
CREATE TABLE t_script (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id  BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    outline_id  BIGINT       NULL COMMENT '关联大纲ID',
    name        VARCHAR(200) NOT NULL DEFAULT '' COMMENT '剧本名称',
    content     MEDIUMTEXT   NOT NULL COMMENT '剧本内容',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_outline_id (outline_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='剧本表';

-- 资产表
CREATE TABLE t_assets (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id  BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    name        VARCHAR(100) NOT NULL DEFAULT '' COMMENT '资产名称',
    intro       TEXT         NOT NULL COMMENT '资产描述',
    prompt      TEXT         NOT NULL COMMENT '生成提示词',
    type        VARCHAR(20)  NOT NULL DEFAULT 'role' COMMENT '类型: role/props/scene',
    file_path   VARCHAR(500) NOT NULL DEFAULT '' COMMENT '图片路径',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_project_type (project_id, type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='资产表';

-- 图片记录表
CREATE TABLE t_image (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id  BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    assets_id   BIGINT       NULL COMMENT '关联资产ID',
    script_id   BIGINT       NULL COMMENT '关联剧本ID',
    type        VARCHAR(20)  NOT NULL DEFAULT '' COMMENT '类型: role/scene/props/storyboard/video/chat',
    file_path   VARCHAR(500) NOT NULL DEFAULT '' COMMENT '图片路径',
    state       TINYINT      NOT NULL DEFAULT 0 COMMENT '状态: 0=生成中, 1=成功, -1=失败',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_assets_id (assets_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='图片记录表';
```

### 2.7 视频生成（4 张表）

```sql
-- 视频记录表
CREATE TABLE t_video (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id      BIGINT        NOT NULL DEFAULT 0 COMMENT '项目ID',
    script_id       BIGINT        NULL COMMENT '关联剧本ID',
    shot_id         VARCHAR(50)   NOT NULL DEFAULT '' COMMENT '关联分镜ID',
    segment_id      INT           NOT NULL DEFAULT 0 COMMENT '关联片段ID',
    config_id       BIGINT        NULL COMMENT '视频配置ID',
    prompt          TEXT          NOT NULL COMMENT '图片提示词',
    video_prompt    TEXT          NOT NULL COMMENT '视频提示词',
    camera_motion   VARCHAR(100)  NOT NULL DEFAULT '' COMMENT '运镜指令',
    file_path       VARCHAR(500)  NOT NULL DEFAULT '' COMMENT '视频文件路径',
    last_frame      VARCHAR(500)  NOT NULL DEFAULT '' COMMENT '最后一帧图片路径',
    state           TINYINT       NOT NULL DEFAULT 0 COMMENT '状态: 0=生成中, 1=成功, -1=失败',
    duration        DECIMAL(6,2)  NOT NULL DEFAULT 0.00 COMMENT '视频时长(秒)',
    resolution      VARCHAR(20)   NOT NULL DEFAULT '' COMMENT '分辨率',
    manufacturer    VARCHAR(50)   NOT NULL DEFAULT '' COMMENT '厂商',
    model           VARCHAR(100)  NOT NULL DEFAULT '' COMMENT '模型',
    task_id         VARCHAR(200)  NOT NULL DEFAULT '' COMMENT '厂商任务ID',
    retry_count     INT           NOT NULL DEFAULT 0 COMMENT '已重试次数',
    max_retry       INT           NOT NULL DEFAULT 3 COMMENT '最大重试次数',
    version         INT           NOT NULL DEFAULT 1 COMMENT '版本号',
    selected        TINYINT       NOT NULL DEFAULT 1 COMMENT '是否选中: 1=是, 0=否',
    error_message   TEXT          NOT NULL COMMENT '错误信息',
    create_time     DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_script_id (script_id),
    INDEX idx_shot_id (shot_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='视频记录表';

-- 视频生成配置表
CREATE TABLE t_video_config (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id      BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    script_id       BIGINT       NULL COMMENT '关联剧本ID',
    manufacturer    VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '厂商',
    mode            VARCHAR(30)  NOT NULL DEFAULT 'singleImage' COMMENT '生成模式',
    resolution      VARCHAR(20)  NOT NULL DEFAULT '720p' COMMENT '分辨率',
    duration        DECIMAL(6,2) NOT NULL DEFAULT 10.00 COMMENT '目标时长(秒)',
    audio_enabled   TINYINT      NOT NULL DEFAULT 0 COMMENT '是否带音频',
    style_prefix    TEXT         NOT NULL COMMENT '统一风格提示词前缀',
    create_time     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_script_id (script_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='视频生成配置表';

-- 视频合成配置表
CREATE TABLE t_video_compose_config (
    id                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id          BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    script_id           BIGINT       NULL COMMENT '关联剧本ID',
    transition          VARCHAR(30)  NOT NULL DEFAULT 'fadeInOut' COMMENT '转场: none/fadeInOut/crossDissolve/blackScreen',
    transition_duration INT          NOT NULL DEFAULT 500 COMMENT '转场时长(ms)',
    bgm_path            VARCHAR(500) NOT NULL DEFAULT '' COMMENT 'BGM文件路径',
    bgm_volume          INT          NOT NULL DEFAULT 30 COMMENT 'BGM音量(0-100)',
    tts_enabled         TINYINT      NOT NULL DEFAULT 0 COMMENT '是否叠加配音',
    tts_volume          INT          NOT NULL DEFAULT 80 COMMENT '配音音量(0-100)',
    subtitle_enabled    TINYINT      NOT NULL DEFAULT 0 COMMENT '是否叠加字幕',
    subtitle_style      JSON         NOT NULL DEFAULT ('{}') COMMENT '字幕样式JSON',
    watermark_enabled   TINYINT      NOT NULL DEFAULT 0 COMMENT '是否叠加水印',
    watermark_type      VARCHAR(10)  NOT NULL DEFAULT 'text' COMMENT '水印类型: text/image',
    watermark_content   VARCHAR(500) NOT NULL DEFAULT '' COMMENT '水印内容',
    watermark_position  VARCHAR(20)  NOT NULL DEFAULT 'bottomRight' COMMENT '水印位置',
    watermark_opacity   INT          NOT NULL DEFAULT 30 COMMENT '水印透明度(0-100)',
    intro_enabled       TINYINT      NOT NULL DEFAULT 0 COMMENT '是否添加片头',
    intro_text          VARCHAR(200) NOT NULL DEFAULT '' COMMENT '片头文字',
    intro_duration      INT          NOT NULL DEFAULT 3 COMMENT '片头时长(秒)',
    outro_enabled       TINYINT      NOT NULL DEFAULT 0 COMMENT '是否添加片尾',
    outro_text          VARCHAR(200) NOT NULL DEFAULT '' COMMENT '片尾文字',
    outro_duration      INT          NOT NULL DEFAULT 3 COMMENT '片尾时长(秒)',
    output_resolution   VARCHAR(20)  NOT NULL DEFAULT '1080p' COMMENT '输出分辨率',
    output_fps          INT          NOT NULL DEFAULT 30 COMMENT '输出帧率',
    create_time         DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time         DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='视频合成配置表';

-- 视频合成任务表
CREATE TABLE t_video_compose (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id      BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    script_id       BIGINT       NULL COMMENT '关联剧本ID',
    config_id       BIGINT       NULL COMMENT '合成配置ID',
    video_ids       JSON         NOT NULL DEFAULT ('[]') COMMENT '参与合成的视频ID列表',
    file_path       VARCHAR(500) NOT NULL DEFAULT '' COMMENT '合成视频文件路径',
    duration        DECIMAL(8,2) NOT NULL DEFAULT 0.00 COMMENT '合成后总时长(秒)',
    state           TINYINT      NOT NULL DEFAULT 0 COMMENT '状态: 0=合成中, 1=成功, -1=失败',
    retry_count     INT          NOT NULL DEFAULT 0 COMMENT '重试次数',
    error_message   TEXT         NOT NULL COMMENT '失败原因',
    create_time     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_script_id (script_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='视频合成任务表';
```

### 2.8 AI 配置与系统（5 张表）

```sql
-- AI模型配置表
CREATE TABLE t_config (
    id           BIGINT AUTO_INCREMENT PRIMARY KEY,
    type         VARCHAR(20)  NOT NULL DEFAULT 'text' COMMENT '模型类型: text/image/video/tts',
    name         VARCHAR(100) NOT NULL DEFAULT '' COMMENT '配置名称',
    manufacturer VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '厂商标识',
    model        VARCHAR(100) NOT NULL DEFAULT '' COMMENT '模型名称',
    api_key      VARCHAR(500) NOT NULL DEFAULT '' COMMENT 'API密钥(AES加密)',
    base_url     VARCHAR(300) NOT NULL DEFAULT '' COMMENT 'API地址',
    create_time  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI模型配置表';

-- 功能→模型映射表
CREATE TABLE t_ai_model_map (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_id   BIGINT       NOT NULL DEFAULT 0 COMMENT '模型配置ID',
    name        VARCHAR(100) NOT NULL DEFAULT '' COMMENT '功能名称(显示用)',
    `key`       VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '功能标识: outlineScriptAgent/storyboardAgent/novelAgent/...',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_key (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='功能模型映射表';

-- 系统设置表
CREATE TABLE t_setting (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id         BIGINT       NOT NULL DEFAULT 0 COMMENT '用户ID(0=全局)',
    token_key       VARCHAR(200) NOT NULL DEFAULT '' COMMENT 'JWT密钥',
    image_model     VARCHAR(100) NOT NULL DEFAULT '' COMMENT '默认图片模型',
    language_model  VARCHAR(100) NOT NULL DEFAULT '' COMMENT '默认语言模型',
    create_time     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统设置表';

-- Prompt模板表
CREATE TABLE t_prompts (
    id            BIGINT AUTO_INCREMENT PRIMARY KEY,
    code          VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '唯一标识',
    name          VARCHAR(100) NOT NULL DEFAULT '' COMMENT '显示名称',
    type          VARCHAR(30)  NOT NULL DEFAULT '' COMMENT '分类: agent/image/video/script/novel',
    default_value MEDIUMTEXT   NOT NULL COMMENT '系统默认Prompt',
    custom_value  MEDIUMTEXT   NOT NULL COMMENT '用户自定义Prompt',
    parent_code   VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '父级code(用于分组)',
    create_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_code (code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Prompt模板表';

-- 对话历史表
CREATE TABLE t_chat_history (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id  BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    type        VARCHAR(30)  NOT NULL DEFAULT '' COMMENT '类型: outlineAgent/storyboardAgent/novelAgent',
    data        JSON         NOT NULL DEFAULT ('[]') COMMENT '消息数组JSON',
    novel       TEXT         NOT NULL COMMENT '关联小说内容(冗余)',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_project_type (project_id, type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='对话历史表';
```

### 2.9 任务与日志（2 张表）

```sql
-- 任务列表表
CREATE TABLE t_task_list (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id  BIGINT       NOT NULL DEFAULT 0 COMMENT '关联项目ID(0=无关联)',
    name        VARCHAR(200) NOT NULL DEFAULT '' COMMENT '任务名称',
    prompt      TEXT         NOT NULL COMMENT '任务描述',
    state       VARCHAR(20)  NOT NULL DEFAULT 'pending' COMMENT '状态: pending/running/success/failed',
    checkpoint  JSON         NOT NULL DEFAULT ('{}') COMMENT '断点续写检查点JSON',
    start_time  DATETIME     NULL COMMENT '开始时间',
    end_time    DATETIME     NULL COMMENT '结束时间',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_state (state)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务列表表';

-- Agent执行日志表
CREATE TABLE t_agent_log (
    id            BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id    BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    agent_type    VARCHAR(30)  NOT NULL DEFAULT '' COMMENT 'Agent类型: novelAgent/outlineAgent/storyboardAgent',
    session_id    VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '会话ID',
    parent_log_id BIGINT       NULL COMMENT '父日志ID(Sub-Agent关联)',
    action        VARCHAR(30)  NOT NULL DEFAULT '' COMMENT '动作: call/invokeSubAgent/toolCall/llmCall',
    agent_name    VARCHAR(50)  NOT NULL DEFAULT '' COMMENT 'Agent名称',
    tool_name     VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '工具名称',
    input         TEXT         NOT NULL COMMENT '输入摘要(截断500字)',
    output        TEXT         NOT NULL COMMENT '输出摘要(截断500字)',
    duration      BIGINT       NOT NULL DEFAULT 0 COMMENT '耗时(ms)',
    token_used    INT          NOT NULL DEFAULT 0 COMMENT 'Token消耗',
    status        VARCHAR(20)  NOT NULL DEFAULT 'success' COMMENT '状态: success/failed/timeout',
    error_message TEXT         NOT NULL COMMENT '错误信息',
    create_time   DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_session_id (session_id),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Agent执行日志表';
```

### 2.10 TTS 配音（2 张表）

```sql
-- TTS配音配置表
CREATE TABLE t_tts_config (
    id           BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id   BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    character_id BIGINT       NULL COMMENT '关联角色ID(NULL=旁白)',
    voice_id     VARCHAR(100) NOT NULL DEFAULT '' COMMENT '音色ID',
    manufacturer VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '厂商: volcengine/aliyun/azure/fishaudio',
    speed        DECIMAL(3,2) NOT NULL DEFAULT 1.00 COMMENT '语速(0.5-2.0)',
    pitch        DECIMAL(3,2) NOT NULL DEFAULT 1.00 COMMENT '音调(0.5-2.0)',
    emotion      VARCHAR(20)  NOT NULL DEFAULT 'neutral' COMMENT '情感: neutral/excited/sad/angry',
    state        TINYINT      NOT NULL DEFAULT 1 COMMENT '状态: 1=启用, 0=禁用',
    create_time  DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='TTS配音配置表';

-- TTS音频记录表
CREATE TABLE t_tts_audio (
    id             BIGINT AUTO_INCREMENT PRIMARY KEY,
    project_id     BIGINT       NOT NULL DEFAULT 0 COMMENT '项目ID',
    script_id      BIGINT       NULL COMMENT '关联剧本ID',
    text           TEXT         NOT NULL COMMENT '台词文本',
    character_name VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '角色名(空=旁白)',
    voice_id       VARCHAR(100) NOT NULL DEFAULT '' COMMENT '音色ID',
    file_path      VARCHAR(500) NOT NULL DEFAULT '' COMMENT '音频文件路径',
    duration       DECIMAL(8,2) NOT NULL DEFAULT 0.00 COMMENT '音频时长(秒)',
    state          TINYINT      NOT NULL DEFAULT 0 COMMENT '状态: 0=生成中, 1=成功, -1=失败',
    create_time    DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_project_id (project_id),
    INDEX idx_script_id (script_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='TTS音频记录表';
```

### 2.11 素材库（1 张表）

```sql
CREATE TABLE t_material (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    name        VARCHAR(200) NOT NULL DEFAULT '' COMMENT '素材名称',
    type        VARCHAR(20)  NOT NULL DEFAULT '' COMMENT '类型: bgm/sfx/intro/outro/watermark',
    file_path   VARCHAR(500) NOT NULL DEFAULT '' COMMENT '文件路径',
    category    VARCHAR(50)  NOT NULL DEFAULT '' COMMENT '分类: 紧张/温馨/热血/悲伤/搞笑/日常',
    duration    DECIMAL(8,2) NOT NULL DEFAULT 0.00 COMMENT '时长(秒,音视频素材)',
    tags        JSON         NOT NULL DEFAULT ('[]') COMMENT '标签JSON数组',
    user_id     BIGINT       NOT NULL DEFAULT 0 COMMENT '上传者ID',
    create_time DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_type (type),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='素材库表';
```

## 三、NULL 字段清单

以下字段允许 NULL，均为外键引用或时间状态字段，语义为"未关联"或"未发生"：

| 表 | 字段 | 说明 |
|---|------|------|
| t_script | outline_id | 剧本可能不关联大纲（手动创建） |
| t_image | assets_id | 图片可能不关联资产（聊天生成等） |
| t_image | script_id | 图片可能不关联剧本 |
| t_video | script_id | 视频可能不关联剧本（独立生成） |
| t_video | config_id | 视频可能使用默认配置 |
| t_video_config | script_id | 配置可能是项目级通用配置 |
| t_video_compose_config | script_id | 同上 |
| t_video_compose | script_id | 合成任务可能跨剧本 |
| t_video_compose | config_id | 可能使用默认配置 |
| t_task_list | start_time | 任务未开始 |
| t_task_list | end_time | 任务未结束 |
| t_agent_log | parent_log_id | 顶层Agent调用无父日志 |
| t_tts_config | character_id | NULL=旁白配置 |
| t_tts_audio | script_id | 音频可能不关联剧本（独立试听） |

其余所有字段均为 `NOT NULL` + 具体默认值。

## 四、ER 关系概览

```
t_user ──1:N──> t_project
t_project ──1:N──> t_novel
t_project ──1:1──> t_novel_world
t_project ──1:N──> t_novel_character
t_project ──1:N──> t_novel_outline
t_project ──1:N──> t_novel_chapter_plan
t_project ──1:N──> t_novel_quality_report
t_project ──1:1──> t_storyline
t_project ──1:N──> t_outline
t_project ──1:N──> t_script
t_project ──1:N──> t_assets
t_project ──1:N──> t_image
t_project ──1:N──> t_video
t_script  ──1:N──> t_video
t_outline ──1:1──> t_script
t_novel   ──1:N──> t_novel_version
t_video   ──N:1──> t_video_config
t_video_compose ──N:1──> t_video_compose_config
```
