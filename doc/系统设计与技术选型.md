# Toonflow Java 版 — 系统设计与技术选型

## 一、项目定位

基于现有 Toonflow（Node.js/TypeScript）重构为 Java 版，扩展 **AI 生成小说** 能力，完成全链路：

```
AI生成小说 / 手动上传小说
    → 故事线生成(AI) → 导演审核
    → 大纲生成(AI) → 导演审核
    → 资产提取 → 剧本生成
    → 分镜生成 → 图片生成 → 视频生成
```

新增能力：用户可通过 AI（文本大模型）直接生成小说章节，而非仅手动上传。

---

## 二、技术栈总览

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 后端框架 | Spring Boot 3.3+ / JDK 21 | Virtual Threads、Record、Pattern Matching |
| Python 服务 | FastAPI + uvicorn | 图片处理（替代 Sharp）、可选的本地模型推理 |
| 前端 | Vue 3 + TypeScript + Vite | Pinia 状态管理、Vue Router |
| 数据库 | MySQL 8.0+（上云后 TiDB / PolarDB） | MyBatis-Plus，JSON 字段用 `JSON` 类型 |
| 缓存 | Redis 7+ | 会话管理、热数据缓存、分布式锁、任务队列 |
| ORM | MyBatis-Plus + 动态 SQL | 复杂查询用 XML Mapper，简单 CRUD 用 BaseMapper |
| AI 集成 | Spring AI 1.0+ | 统一 ChatClient 接口，支持多厂商 |
| WebSocket | Spring WebSocket + STOMP | Agent 流式输出、实时通信 |
| 消息队列 | Redis Stream / RabbitMQ | 异步任务调度、Agent 任务分发 |
| 异步任务 | Virtual Threads + CompletableFuture | 视频生成轮询、图片批量处理 |
| 认证 | Spring Security + JWT + Redis | jjwt 库，Token 存 Redis 支持主动失效 |
| 文件存储 | 云 OSS（S3 兼容，如 AWS S3 / 阿里云 OSS / 腾讯云 COS） | 统一 S3 SDK 接口 |
| 图片处理 | Python FastAPI 微服务 | Sharp → Python Pillow/OpenCV，宫格图分割、压缩 |
| 日志 | Logback + SLF4J | 文件轮转 + ELK（上云） |
| 容器化 | Docker + docker-compose / Kubernetes | Java + Python + Vue(Nginx) + MySQL + Redis |
| 构建工具 | Gradle (Kotlin DSL) | 比 Maven 更灵活 |

---

## 三、系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    Vue 3 前端 (Nginx)                    │
│         Vite + TypeScript + Pinia + Vue Router           │
└──────────────┬──────────────────────┬───────────────────┘
               │ REST API             │ WebSocket (STOMP)
               ▼                      ▼
┌─────────────────────────────────────────────────────────┐
│              Spring Boot 3 主服务 (JDK 21)               │
│                                                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────────┐ │
│  │Controller│ │ Agent    │ │ AI       │ │  Security  │ │
│  │  Layer   │ │ System   │ │ Provider │ │  + JWT     │ │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────────────┘ │
│       │            │            │                        │
│  ┌────▼─────┐ ┌────▼─────┐ ┌───▼──────┐                │
│  │ Service  │ │ Tool     │ │ Model    │                 │
│  │  Layer   │ │ Registry │ │ Registry │                 │
│  └────┬─────┘ └──────────┘ └──────────┘                 │
│       │                                                  │
│  ┌────▼──────────────┐  ┌───────────────┐               │
│  │ MyBatis-Plus      │  │    Redis 7+   │               │
│  │ + MySQL 8.0       │  │ 缓存/锁/队列  │               │
│  └───────────────────┘  └───────────────┘               │
└──────────────┬──────────────────────────────────────────┘
               │ HTTP (内部调用)
               ▼
┌─────────────────────────────────────────────────────────┐
│           Python FastAPI 微服务                          │
│  - 图片压缩/拼接/分割 (Pillow/OpenCV)                    │
│  - 宫格图处理                                            │
│  - 视频合成 (FFmpeg)：拼接/转场/字幕/BGM/配音/水印        │
│  - 文档导出 (python-docx / reportlab)                    │
│  - 可选：本地模型推理 (Stable Diffusion 等)               │
└─────────────────────────────────────────────────────────┘
```

---

## 四、数据模型设计（30 张表，详见 PRD 第四章）

### 4.1 原有表映射

所有表直接映射为 MyBatis-Plus Entity，JSON 字段使用 MySQL `JSON` 类型 + Jackson TypeHandler 序列化。

```java
// 示例：t_outline 的 data 字段存 EpisodeData JSON
@Data
@TableName("t_outline")
public class Outline {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Integer episode;
    private Long projectId;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private EpisodeData data;  // 自动 JSON 序列化/反序列化
}
```

| 表名 | 核心字段 | Java 映射要点 |
|------|---------|--------------|
| t_user | id, name, password | 密码用 BCrypt 加密 |
| t_project | id, name, intro, type, artStyle, videoRatio, createTime, userId | `createTime` 用 `Instant` |
| t_novel | id, chapterIndex, reel, chapter, chapterData, projectId | `chapterData` 存原文全文 (TEXT) |
| t_storyline | id, name, content, novelIds, projectId | `content` 大文本 (TEXT) |
| t_outline | id, episode, data, projectId | `data` → `EpisodeData` (JSON) |
| t_script | id, name, content, projectId, outlineId | `content` 存剧本文本 (TEXT) |
| t_assets | id, name, intro, prompt, type, filePath, projectId... | `type`: role/props/scene |
| t_image | id, filePath, type, assetsId, scriptId, projectId | 图片记录 |
| t_video | id, prompt, filePath, state, scriptId, configId... | `state`: 0/1/-1 |
| t_video_config | id, scriptId, projectId, manufacturer, mode, resolution... | 视频生成配置 |
| t_config | id, type, model, apiKey, baseUrl, manufacturer | AI 模型配置 |
| t_ai_model_map | id, configId, name, key | 功能→模型映射 |
| t_setting | id, userId, tokenKey, imageModel, languageModel | 系统设置 |
| t_prompts | id, code, name, type, defaultValue, customValue | Prompt 模板 |
| t_chat_history | id, type, data, novel, projectId | `data` 存 JSON 消息数组 |
| t_task_list | id, name, prompt, state, startTime, endTime | 任务列表 |

### 4.2 新增表

```sql
-- AI 小说生成记录
CREATE TABLE t_novel_generation (
    id          BIGSERIAL PRIMARY KEY,
    project_id  BIGINT NOT NULL REFERENCES t_project(id),
    prompt      TEXT,           -- 用户给 AI 的创作提示
    genre       VARCHAR(50),    -- 题材：玄幻/都市/科幻/言情...
    style       VARCHAR(50),    -- 风格：轻松/严肃/悬疑...
    chapter_count INT,          -- 目标章节数
    words_per_chapter INT,      -- 每章目标字数
    state       INT DEFAULT 0,  -- 0=生成中, 1=完成, -1=失败
    model_config_id BIGINT,     -- 使用的 AI 模型配置
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.3 EpisodeData POJO

```java
public record EpisodeData(
    int episodeIndex,
    String title,
    List<Integer> chapterRange,
    List<AssetItem> scenes,
    List<AssetItem> characters,
    List<AssetItem> props,
    String coreConflict,
    String outline,
    String openingHook,
    List<String> keyEvents,      // 4 个元素：起、承、转、合
    String emotionalCurve,
    List<String> visualHighlights,
    String endingHook,
    List<String> classicQuotes
) {}

public record AssetItem(String name, String description) {}
```

---

## 五、核心模块设计

### 5.1 AI Provider 层（多厂商统一接口）

```
ai/
├── text/
│   ├── TextAiProvider.java          // 接口：invoke() + stream()
│   ├── TextAiProviderFactory.java   // 工厂：根据 manufacturer 创建实例
│   ├── TextModelRegistry.java       // 模型注册表（对应原 modelList.ts）
│   └── impl/
│       ├── DeepSeekProvider.java
│       ├── QwenProvider.java
│       ├── DoubaoProvider.java
│       ├── ZhipuProvider.java
│       ├── OpenAiProvider.java
│       ├── GeminiProvider.java
│       ├── AnthropicProvider.java
│       ├── XaiProvider.java
│       └── OpenAiCompatibleProvider.java  // 自定义兼容接口
├── image/
│   ├── ImageAiProvider.java         // 接口
│   ├── ImageAiProviderFactory.java
│   └── impl/
│       ├── GeminiImageProvider.java
│       ├── VolcengineImageProvider.java
│       ├── KlingImageProvider.java
│       ├── ViduImageProvider.java
│       └── RunninghubImageProvider.java
└── video/
    ├── VideoAiProvider.java         // 接口
    ├── VideoAiProviderFactory.java
    └── impl/
        ├── VolcengineVideoProvider.java
        ├── KlingVideoProvider.java
        ├── ViduVideoProvider.java
        ├── WanVideoProvider.java
        ├── GeminiVideoProvider.java
        ├── RunninghubVideoProvider.java
        └── ApimartVideoProvider.java
```

关键接口设计：

```java
public interface TextAiProvider {
    // 一次性生成
    <T> T invoke(AiRequest request, Class<T> outputType);
    // 无结构化输出
    String invoke(AiRequest request);
    // 流式生成
    Flux<String> stream(AiRequest request);
}

public interface ImageAiProvider {
    // 返回 base64 或 URL
    String generate(ImageRequest request);
}

public interface VideoAiProvider {
    // 创建任务，返回 taskId
    String createTask(VideoRequest request);
    // 轮询任务状态
    VideoTaskResult pollTask(String taskId);
}
```

底层 LLM 配置化：所有模型配置存在 `t_config` 表中，用户可在前端自由配置 apiKey、baseUrl、model 等。`t_ai_model_map` 表将 8 个功能点（故事师、大纲师、剧本生成、分镜Agent 等）各绑定一个模型配置，实现功能级别的模型切换。

Spring AI 集成方案：
- 对于支持 Spring AI 的厂商（OpenAI、Anthropic、Gemini 等），直接用 `ChatClient`
- 对于国产厂商（豆包、智谱、通义千问），封装 HTTP 调用，实现统一的 `TextAiProvider` 接口
- `responseFormat` 分两种策略：`schema`（模型原生 JSON Schema）和 `object`（system prompt 附加 schema 提示 + 后处理解析）

### 5.2 多智能体系统（Agent System）

这是系统最核心的部分，原项目有两个 Agent 系统：

#### OutlineScript Agent（大纲故事线 Agent）

```
MainAgent（协调者）
├── AI1（故事师）：分析小说 → 生成故事线
├── AI2（大纲师）：根据故事线 → 生成大纲
└── Director（导演）：审核故事线/大纲，提出修改意见
```

#### Storyboard Agent（分镜 Agent）

```
MainAgent（协调者）
├── segmentAgent（片段师）：拆分剧本为片段
└── shotAgent（分镜师）：为片段生成镜头提示词
```

#### 新增：NovelGeneration Agent（小说生成 Agent·多智能体）

```
NovelMainAgent（总编/调度器）
├── WorldArchitect（世界架构师）：构建世界观、力量体系
├── CharacterDesigner（角色设计师）：设计角色群像
├── PlotArchitect（情节架构师）：规划全书大纲+分卷
├── ChapterPlanner（章节规划师）：规划每章概要
├── NovelWriter（小说写手）：逐章生成正文（流式）
├── Editor（总编审）：审核质量，可打回修改
└── QualityInspector（质检官）：多维度深度质检
```

详细设计见 PRD M4 章节（F4.1-F4.15），包含：
- 5 层递进生成流水线（世界观→角色→大纲→章概要→正文）
- 四层记忆体系 + TOON 格式上下文管理
- 7 维度质检系统
- 系统级写作质量指令（去 AI 味 + 网文特化）

#### Java Agent 架构设计

```java
// Agent 基类
public abstract class BaseAgent {
    protected final Long projectId;
    protected final List<ChatMessage> history = new CopyOnWriteArrayList<>();
    protected final Map<String, AgentTool> tools = new ConcurrentHashMap<>();
    protected final SimpMessagingTemplate messagingTemplate; // WebSocket 推送

    // 子类实现：定义可用工具
    protected abstract Map<String, AgentTool> registerTools();

    // 子类实现：构建 system prompt
    protected abstract String buildSystemPrompt();

    // 调用 LLM，支持工具调用循环
    public Flux<String> call(String userMessage) {
        history.add(ChatMessage.user(userMessage));
        return executeWithTools(buildSystemPrompt(), history, tools);
    }

    // 调用子 Agent
    protected Flux<String> callSubAgent(SubAgentType type, String task) {
        // 构建子 Agent 上下文，调用对应 LLM，流式返回
    }
}

// 工具定义
@FunctionalInterface
public interface AgentTool {
    Object execute(Map<String, Object> params);
}

// 工具注解（类似 Spring AI 的 @Tool）
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Tool {
    String name();
    String description();
}
```

#### Agent 通信机制

```
前端 (Vue)  ←→  WebSocket (STOMP)  ←→  AgentController  ←→  Agent 实例
                                                              │
                                                              ├── emitStream(text)     → /topic/agent/{projectId}/stream
                                                              ├── emitSubAgent(data)   → /topic/agent/{projectId}/subAgent
                                                              ├── emitToolCall(data)   → /topic/agent/{projectId}/toolCall
                                                              └── emitRefresh(type)    → /topic/agent/{projectId}/refresh
```

### 5.3 AI 小说生成模块（新增核心功能）

```java
@Service
public class NovelGenerationService {

    // 生成小说大纲（整体情节架构）
    public NovelOutline generateNovelOutline(NovelGenerationRequest request) {
        // 1. 调用 PlotDesigner Agent
        // 2. 返回：题材、主线、人物设定、章节规划
    }

    // 逐章生成小说
    public Flux<String> generateChapter(Long projectId, int chapterIndex) {
        // 1. 获取前文上下文（前 N 章摘要 + 当前章大纲）
        // 2. 调用 ChapterWriter Agent，流式输出
        // 3. 生成完毕后存入 t_novel
    }

    // 批量生成所有章节
    public void generateAllChapters(Long projectId) {
        // 异步逐章生成，每章完成后通知前端
    }
}
```

### 5.4 Python 微服务（图片处理）

```python
# python-service/main.py
from fastapi import FastAPI
from PIL import Image
import io, base64

app = FastAPI()

@app.post("/image/split-grid")
async def split_grid(request: GridSplitRequest):
    """将宫格图分割为单张镜头图"""
    pass

@app.post("/image/merge")
async def merge_images(request: MergeRequest):
    """拼接多张图片"""
    pass

@app.post("/image/compress")
async def compress_image(request: CompressRequest):
    """压缩图片到指定大小"""
    pass

@app.post("/image/super-resolution")
async def super_resolution(request: SuperResRequest):
    """图片超分辨率（可选，用 Real-ESRGAN）"""
    pass

@app.post("/video/compose")
async def compose_video(request: ComposeRequest):
    """视频合成：拼接+转场+字幕+BGM+配音+水印"""
    pass

@app.post("/export/pdf")
async def export_pdf(request: ExportRequest):
    """小说导出为 PDF"""
    pass

@app.post("/export/docx")
async def export_docx(request: ExportRequest):
    """小说导出为 Word"""
    pass
```

---

## 六、API 设计

### 6.1 RESTful API 映射

原项目 77 个路由，按模块重新组织为标准 RESTful 风格：

| 模块 | 原路由示例 | Java API |
|------|-----------|----------|
| 认证 | POST /other/login | POST /api/auth/login |
| 用户 | GET /user/getUser | GET /api/users/me |
| 项目 | POST /project/addProject | POST /api/projects |
| 项目 | GET /project/getProject | GET /api/projects?page=&size= |
| 项目 | GET /project/getSingleProject | GET /api/projects/{id} |
| 小说 | POST /novel/addNovel | POST /api/projects/{projectId}/novels |
| 小说 | GET /novel/getNovel | GET /api/projects/{projectId}/novels |
| 小说生成(新) | — | POST /api/projects/{projectId}/novels/generate |
| 故事线 | GET /outline/getStoryline | GET /api/projects/{projectId}/storylines |
| 大纲 | GET /outline/getOutline | GET /api/projects/{projectId}/outlines |
| 剧本 | POST /script/generateScriptApi | POST /api/scripts/{scriptId}/generate |
| 资产 | GET /assets/getAssets | GET /api/projects/{projectId}/assets |
| 分镜 | GET /storyboard/getStoryboard | GET /api/scripts/{scriptId}/storyboards |
| 视频 | POST /video/generateVideo | POST /api/videos/generate |
| 模型配置 | POST /setting/addModel | POST /api/settings/models |
| Prompt | GET /prompt/getPrompts | GET /api/prompts |
| 任务 | GET /task/getTaskApi | GET /api/tasks |

### 6.2 WebSocket 端点

| 端点 | 用途 |
|------|------|
| /ws/agent/outline/{projectId} | 大纲故事线 Agent 对话 |
| /ws/agent/storyboard/{projectId}/{scriptId} | 分镜 Agent 对话 |
| /ws/agent/novel/{projectId} | 小说生成 Agent 对话（新增） |
| /ws/pipeline/{projectId} | 全自动流水线进度推送（新增） |
| /ws/agent/chat/{projectId} | 通用聊天（分镜聊天等） |

### 6.3 统一响应格式

```java
public record ApiResponse<T>(int code, String message, T data) {
    public static <T> ApiResponse<T> ok(T data) {
        return new ApiResponse<>(200, "success", data);
    }
    public static <T> ApiResponse<T> error(String message) {
        return new ApiResponse<>(500, message, null);
    }
}
```

---

## 七、项目结构

```
toonflow-java/
├── docker/
│   ├── docker-compose.yml
│   ├── Dockerfile.java          # Java 服务
│   ├── Dockerfile.python        # Python 图片服务
│   └── nginx.conf               # 前端 + 反向代理
├── storyforge-server/            # Spring Boot 主服务
│   ├── pom.xml
│   └── src/main/java/com/toonflow/
│       ├── ToonflowApplication.java
│       ├── config/
│       │   ├── SecurityConfig.java
│       │   ├── WebSocketConfig.java
│       │   ├── JacksonConfig.java
│       │   └── AsyncConfig.java
│       ├── controller/
│       │   ├── AuthController.java
│       │   ├── ProjectController.java
│       │   ├── NovelController.java
│       │   ├── OutlineController.java
│       │   ├── ScriptController.java
│       │   ├── AssetController.java
│       │   ├── StoryboardController.java
│       │   ├── VideoController.java
│       │   ├── SettingController.java
│       │   ├── PromptController.java
│       │   └── TaskController.java
│       ├── dto/                  # 请求/响应 DTO
│       ├── entity/               # MyBatis-Plus Entity（30 张表）
│       ├── mapper/               # MyBatis-Plus Mapper
│       ├── service/
│       │   ├── NovelService.java
│       │   ├── NovelGenerationService.java  # AI 生成小说
│       │   ├── OutlineService.java
│       │   ├── ScriptService.java
│       │   ├── AssetService.java
│       │   ├── StoryboardService.java
│       │   ├── VideoService.java
│       │   ├── VideoComposeService.java     # 视频合成
│       │   ├── TtsService.java              # AI 配音
│       │   ├── MaterialService.java         # 素材库
│       │   ├── ExportService.java           # 小说导出
│       │   ├── PipelineService.java         # 全自动流水线
│       │   ├── MonitorService.java          # 生产监控
│       │   └── PromptService.java
│       ├── agent/                # 多智能体系统
│       │   ├── BaseAgent.java
│       │   ├── AgentTool.java
│       │   ├── outline/
│       │   │   └── OutlineScriptAgent.java
│       │   ├── storyboard/
│       │   │   └── StoryboardAgent.java
│       │   └── novel/            # 新增
│       │       └── NovelGenerationAgent.java
│       ├── ai/                   # AI Provider 层
│       │   ├── text/
│       │   ├── image/
│       │   └── video/
│       ├── websocket/
│       │   └── AgentWebSocketHandler.java
│       └── util/
│           ├── JwtUtil.java
│           └── OssClient.java
├── python-service/              # Python 图片处理微服务
│   ├── requirements.txt
│   ├── main.py
│   └── image_processor.py
├── frontend/                    # Vue 3 前端
│   ├── package.json
│   ├── vite.config.ts
│   └── src/
│       ├── api/                 # Axios API 封装
│       ├── views/
│       ├── components/
│       ├── stores/              # Pinia
│       ├── router/
│       └── composables/         # WebSocket hooks
└── docs/
```

---

## 八、关键技术决策

### 8.1 为什么用 JDK 21 Virtual Threads

原项目大量异步操作（视频轮询 500 次 × 2 秒、图片批量生成），Virtual Threads 天然适合这种 IO 密集场景，代码比 `@Async + CompletableFuture` 更简洁：

```java
// 视频生成轮询 — 用 Virtual Thread 直接阻塞式写法
Thread.startVirtualThread(() -> {
    for (int i = 0; i < 500; i++) {
        Thread.sleep(Duration.ofSeconds(2));
        var result = videoProvider.pollTask(taskId);
        if (result.isCompleted()) {
            // 更新数据库状态
            break;
        }
    }
});
```

### 8.2 为什么用 Python 微服务

原项目用 Sharp（C++ 绑定的 Node.js 图片库）做宫格图分割、拼接、压缩。Java 的 `javax.imageio` 和 Thumbnailator 在这些场景下功能和性能都不如 Python 的 Pillow/OpenCV。Python 服务独立部署，通过 HTTP 内部调用，解耦且易扩展（后续可加本地 Stable Diffusion 推理）。

### 8.3 为什么用 MySQL

原项目用 SQLite（单文件数据库，适合 Electron 桌面应用）。Java 版定位为企业级 Web 服务，MySQL 8.0+ 提供：
- `JSON` 类型支持 JSON 查询（`JSON_EXTRACT`、`->`、`->>`）
- 成熟的主从复制、读写分离方案
- 上云后可无缝切换到 TiDB / PolarDB 等分布式数据库
- 生态最成熟，运维成本最低

### 8.4 Prompt 模板管理

保持原项目的 `t_prompts` 表设计，`defaultValue` 存系统默认 prompt，`customValue` 存用户自定义覆盖。代码中优先使用 `customValue`，为空则 fallback 到 `defaultValue`。

---

## 九、开发路线图（建议分 5 期）

### Phase 1：基础骨架（1-2 周）
- Spring Boot 项目搭建、数据库建表（30 张表）、MyBatis-Plus Entity
- JWT + Redis 认证、统一响应、全局异常处理、多租户拦截器
- 用户/项目/小说/Prompt 的 CRUD API
- Vue 前端脚手架 + 登录页 + 项目列表页

### Phase 2：AI 集成 + 小说生成（3-4 周）
- TextAiProvider 多厂商实现（优先 Qwen、DeepSeek、OpenAI）
- AI 小说生成 Agent 系统（M4：7 个 Sub-Agent + 5 层流水线）
- 四层记忆体系 + TOON 格式上下文管理
- 质检系统（7 维度评分 + 自动修复）
- Prompt 模板管理
- 前端：小说生成页、章节编辑页、Agent 对话界面

### Phase 3：内容生产流水线（3-4 周）
- OutlineScriptAgent（故事线 + 大纲生成）
- StoryboardAgent（分镜生成）
- WebSocket 实时通信（Agent 对话 + 进度推送）
- ImageAiProvider + Python 图片处理服务
- 剧本生成、资产提取、图片质量检测
- 前端：大纲/剧本/分镜编辑页、资产管理页

### Phase 4：视频生成 + 合成（2-3 周）
- VideoAiProvider 多厂商实现
- 异步视频生成 + 自动重试 + 状态轮询
- 视频合成（FFmpeg：拼接+转场+字幕+BGM+水印）
- AI 配音（TTS 多厂商集成）
- 素材库管理（BGM/片头片尾/水印）
- 小说导出（TXT/EPUB/PDF/Word）
- 前端：视频生成页、合成页、配音页、素材库页

### Phase 5：企业级 + 全自动（2-3 周）
- 全自动内容生产流水线（M20：11 步全链路）
- Redis Stream 任务队列 + Worker 池 + 批量生产
- 模型负载均衡（轮询/权重/最少连接 + 故障切换）
- 生产监控仪表盘 + 告警
- 用户管理 + 配额管理
- Docker 部署 + 性能调优
- 前端：流水线页、监控仪表盘、用户管理页

---

## 十、Docker 部署架构

```yaml
# docker-compose.yml
services:
  mysql:
    image: mysql:8.0
    volumes:
      - mysqldata:/var/lib/mysql
    environment:
      MYSQL_DATABASE: toonflow
      MYSQL_USER: toonflow
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}

  redis:
    image: redis:7-alpine
    volumes:
      - redisdata:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    depends_on: [mysql, redis]
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/toonflow?useUnicode=true&characterEncoding=utf8mb4&serverTimezone=Asia/Shanghai
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      OSS_ENDPOINT: ${OSS_ENDPOINT}
      OSS_ACCESS_KEY: ${OSS_ACCESS_KEY}
      OSS_SECRET_KEY: ${OSS_SECRET_KEY}
      OSS_BUCKET: ${OSS_BUCKET}

  python-service:
    build:
      context: ./python-service
      dockerfile: Dockerfile
    ports:
      - "8001:8001"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on: [backend]

volumes:
  mysqldata:
  redisdata:
```
